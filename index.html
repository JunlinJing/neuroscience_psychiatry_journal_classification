<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025年神经科学/精神病学期刊分区表</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.10.5/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* Import Noto Sans SC font from Google Fonts */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        /* Apply the font to the body and set background color */
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f9fafb; /* Light gray background */
        }

        /* Style for active zone tabs */
        .zone-tabs .active-tab {
            border-bottom: 3px solid #3b82f6; /* Blue bottom border */
            color: #1e40af; /* Darker blue text */
            font-weight: 600; /* Medium font weight */
        }

        /* Background colors for different zones */
        .zone-1 { background-color: #dbeafe; } /* Light blue */
        .zone-1-header { background-color: #3b82f6; } /* Blue */

        .zone-2 { background-color: #e0f2fe; } /* Lighter blue */
        .zone-2-header { background-color: #0ea5e9; } /* Sky blue */

        .zone-3 { background-color: #f0fdfa; } /* Light teal */
        .zone-3-header { background-color: #14b8a6; } /* Teal */

        .zone-4 { background-color: #fef3c7; } /* Light yellow */
        .zone-4-header { background-color: #f59e0b; } /* Amber */

        /* Make table headers sticky */
        table.dataTable thead th {
            position: sticky;
            top: 0;
            background-color: white;
            z-index: 10; /* Ensure header is above table content */
        }

        /* Add padding to the top section of the DataTable */
        .dataTable-wrapper .dataTable-top {
            padding: 1rem 0;
        }

        /* Print-specific styles */
        @media print {
            /* Hide elements with 'no-print' class */
            .no-print {
                display: none !important;
            }

            /* Avoid breaking inside elements during printing */
            .print-break-inside-avoid {
                break-inside: avoid;
            }

            /* Ensure full width and auto height for printing */
            html, body {
                width: 100%;
                height: auto;
            }

            /* Make sure tab content is visible when printing */
            .zone-tab-content {
                display: block !important;
                opacity: 1 !important;
                height: auto !important;
            }
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8" x-data="journalApp()">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">2025年神经科学/精神病学期刊分区表</h1>
            <p class="text-gray-600 max-w-3xl mx-auto">基于2025年中国科学院文献情报中心发布的最新期刊分区数据，包含神经科学、精神病学及相关领域的期刊分类信息。</p>
        </header>
        
        <!-- 导入数据模态框 -->
        <div x-show="showImportModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div @click.outside="showImportModal = false" class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">导入期刊数据</h3>
                    <button @click="showImportModal = false" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="mb-4">
                    <p class="text-gray-600 mb-2">您可以导入Excel或CSV格式的期刊数据。文件应包含以下列：</p>
                    <ul class="text-sm text-gray-600 list-disc pl-5 mb-3">
                        <li>期刊全称（英文）</li>
                        <li>期刊全称（中文）</li>
                        <li>期刊缩写</li>
                        <li>ISSN</li>
                        <li>影响因子</li>
                        <li>分区信息（1-4）</li>
                        <li>学科分类</li>
                    </ul>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">选择文件格式：</label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" x-model="importFormat" value="xlsx" class="form-radio text-blue-600">
                            <span class="ml-2 text-gray-700">Excel (XLSX)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" x-model="importFormat" value="csv" class="form-radio text-blue-600">
                            <span class="ml-2 text-gray-700">CSV</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" x-model="importFormat" value="json" class="form-radio text-blue-600">
                            <span class="ml-2 text-gray-700">JSON</span>
                        </label>
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-medium mb-2">选择文件：</label>
                    <div class="relative border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:bg-gray-50 transition-colors">
                        <input 
                            type="file" 
                            id="fileInput" 
                            @change="handleFileSelect" 
                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                            :accept="importFormat === 'xlsx' ? '.xlsx,.xls' : importFormat === 'csv' ? '.csv' : '.json'"
                        >
                        <div class="space-y-1 text-center">
                            <i class="fas fa-file-upload text-gray-400 text-3xl"></i>
                            <div class="text-sm text-gray-600">
                                <span>点击或拖拽文件到此处</span>
                            </div>
                            <p class="text-xs text-gray-500" x-text="selectedFileName || '支持的格式: ' + (importFormat === 'xlsx' ? 'Excel文件' : importFormat === 'csv' ? 'CSV文件' : 'JSON文件')"></p>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-between items-center pt-3">
                    <button 
                        @click="showImportModal = false" 
                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300"
                    >
                        取消
                    </button>
                    <button 
                        @click="importData()" 
                        :disabled="!selectedFile" 
                        :class="{'opacity-50 cursor-not-allowed': !selectedFile}"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
                    >
                        导入数据
                    </button>
                </div>
                
                <!-- 导入进度和结果提示 -->
                <div x-show="importStatus" class="mt-4 p-3 rounded" :class="importStatus.type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'">
                    <p x-text="importStatus.message"></p>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4 mb-8 no-print">
            <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                <div class="w-full md:w-2/5 mb-4 md:mb-0">
                    <div class="relative">
                        <input
                            type="text"
                            x-model="searchTerm"
                            @input.debounce.300ms="filterJournals()" placeholder="搜索期刊名称、ISSN或缩写..."
                            class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                        <div class="absolute left-3 top-2.5 text-gray-400">
                            <i class="fas fa-search"></i> </div>
                    </div>
                </div>

                <div class="w-full md:w-3/5 flex flex-wrap justify-end gap-2">
                    <div class="flex items-center mr-4">
                        <label class="mr-2 text-gray-700 text-sm">学科:</label>
                        <select
                            x-model="disciplineFilter"
                            @change="filterJournals()"
                            class="border rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="all">全部</option>
                            <option value="neuroscience">神经科学</option>
                            <option value="psychiatry">精神病学</option>
                            <option value="neurology">神经病学</option>
                            <option value="psychology">心理学</option>
                            <option value="pharmacology">药理学</option>
                            <option value="biochemistry">生物化学</option>
                        </select>
                    </div>

                    <div class="flex items-center mr-4">
                        <label class="mr-2 text-gray-700 text-sm">收录:</label>
                        <select
                            x-model="indexFilter"
                            @change="filterJournals()"
                            class="border rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <option value="all">全部</option>
                            <option value="SCI">SCI</option>
                            <option value="SCIE">SCIE</option>
                            <option value="SSCI">SSCI</option>
                            <option value="ESCI">ESCI</option>
                        </select>
                    </div>
                    
                    <div class="flex gap-2">
                        <button
                            @click="exportToXLSX()" class="px-3 py-1.5 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm flex items-center"
                        >
                            <i class="fas fa-file-excel mr-1"></i> 导出XLSX
                        </button>
                        
                        <div class="relative">
                            <button
                                @click="showImportModal = true" class="px-3 py-1.5 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm flex items-center"
                            >
                                <i class="fas fa-file-import mr-1"></i> 导入数据
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-wrap items-center text-sm text-gray-600 mt-2">
                <span class="mr-6"><i class="fas fa-filter mr-1"></i> 当前筛选:</span>
                <span class="inline-flex items-center bg-blue-100 text-blue-800 rounded-full px-3 py-0.5 mr-2 mb-1" x-show="disciplineFilter !== 'all'">
                    学科: <span x-text="getDisciplineName(disciplineFilter)" class="ml-1 font-medium"></span>
                    <button @click="disciplineFilter = 'all'; filterJournals()" class="ml-1 text-blue-600 hover:text-blue-800">
                        <i class="fas fa-times-circle"></i> </button>
                </span>
                <span class="inline-flex items-center bg-blue-100 text-blue-800 rounded-full px-3 py-0.5 mr-2 mb-1" x-show="indexFilter !== 'all'">
                    收录: <span x-text="indexFilter" class="ml-1 font-medium"></span>
                    <button @click="indexFilter = 'all'; filterJournals()" class="ml-1 text-blue-600 hover:text-blue-800">
                        <i class="fas fa-times-circle"></i> </button>
                </span>
                <span class="inline-flex items-center bg-blue-100 text-blue-800 rounded-full px-3 py-0.5 mr-2 mb-1" x-show="searchTerm !== ''">
                    关键词: "<span x-text="searchTerm" class="ml-1 font-medium"></span>"
                    <button @click="searchTerm = ''; filterJournals()" class="ml-1 text-blue-600 hover:text-blue-800">
                        <i class="fas fa-times-circle"></i> </button>
                </span>
                 <span class="text-gray-500 ml-auto" x-text="`总计: ${totalFilteredJournals} 本期刊`"></span>
            </div>
        </div>

        <div class="zone-tabs flex border-b mb-6 no-print">
            <template x-for="(tab, index) in tabs" :key="index">
                <button
                    :class="{'active-tab': activeTab === tab.id}"
                    class="px-6 py-2 text-gray-600 hover:text-gray-900 focus:outline-none"
                    @click="activeTab = tab.id"
                    x-text="tab.name"
                ></button>
            </template>
        </div>

        <template x-for="(tab, index) in tabs" :key="index">
            <div
                x-show="activeTab === tab.id" x-transition :class="{'zone-tab-content': true, 'print-break-inside-avoid': true}"
                :id="'zone-' + tab.id"
            >
                <div :class="`zone-${tab.id}-header text-white rounded-t-lg py-3 px-4 flex justify-between items-center`">
                    <h2 class="text-xl font-semibold" x-text="tab.name + ' 期刊列表'"></h2>
                    <span class="text-white bg-white bg-opacity-20 rounded-full px-3 py-1 text-sm">
                        共 <span x-text="getZoneJournalCount(tab.id)"></span> 本期刊 </span>
                </div>

                <div :class="`zone-${tab.id} rounded-b-lg p-1 md:p-4 overflow-x-auto`">
                    <!-- 添加调试信息 -->
                    <div x-show="filteredData[tab.id].length === 0" class="text-center py-4 text-gray-500">
                        未找到匹配的期刊数据
                    </div>
                    <div x-show="filteredData[tab.id].length > 0" class="text-sm text-gray-600 mb-2">
                        显示 <span x-text="filteredData[tab.id].length"></span> 条记录
                    </div>
                    <table class="w-full stripe hover border-collapse"> 
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="text-left p-2 border">期刊全称（英文/中文）</th>
                                <th class="text-left p-2 border">期刊缩写</th>
                                <th class="text-center p-2 border">ISSN</th>
                                <th class="text-center p-2 border">影响因子</th>
                                <th class="text-center p-2 border">h指数</th>
                                <th class="text-center p-2 border">CiteScore</th>
                                <th class="text-center p-2 border">JCR分区</th>
                                <th class="text-center p-2 border">中科院大类</th>
                                <th class="text-center p-2 border">中科院小类</th>
                                <th class="text-center p-2 border">收录情况</th>
                                <th class="text-center p-2 border">OA</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 使用计算后的分页数据 -->
                            <template x-for="(journal, jIndex) in getPaginatedData(tab.id)" :key="jIndex"> <tr class="hover:bg-gray-100 border-b">
                                    <td>
                                        <div class="font-medium" x-text="journal.nameEn"></div>
                                        <div class="text-sm text-gray-600" x-text="journal.nameCn || '-'"></div>
                                    </td>
                                    <td x-text="journal.abbr || '-'"></td>
                                    <td class="text-center" x-text="journal.issn"></td>
                                    <td class="text-center font-medium" x-text="journal.impactFactor || '-'"></td>
                                    <td class="text-center" x-text="journal.hIndex || '-'"></td>
                                    <td class="text-center" x-text="journal.citeScore || '-'"></td>
                                    <td class="text-center">
                                        <span
                                            :class="{
                                                'px-2 py-0.5 rounded text-xs font-medium': true,
                                                'bg-blue-100 text-blue-800': journal.jcrQuartile === 'Q1',
                                                'bg-green-100 text-green-800': journal.jcrQuartile === 'Q2',
                                                'bg-yellow-100 text-yellow-800': journal.jcrQuartile === 'Q3',
                                                'bg-red-100 text-red-800': journal.jcrQuartile === 'Q4',
                                                'bg-gray-100 text-gray-800': !journal.jcrQuartile
                                            }"
                                            x-text="journal.jcrQuartile || '-'"
                                        ></span>
                                    </td>
                                    <td class="text-center" x-text="journal.casCategory || '-'"></td>
                                    <td class="text-center" x-text="journal.casSubcategory || '-'"></td>
                                    <td class="text-center" x-text="journal.indexing || '-'"></td>
                                    <td class="text-center">
                                        <i
                                            :class="{
                                                'fas': true,
                                                'fa-check text-green-600': journal.isOA === 'Yes',
                                                'fa-times text-red-600': journal.isOA === 'No',
                                                'fa-question text-gray-500': journal.isOA !== 'Yes' && journal.isOA !== 'No' // Handle other cases
                                            }"
                                        ></i>
                                    </td>
                                </tr>
                            </template>
                             <template x-if="filteredData[tab.id].length === 0">
                                <tr>
                                    <td colspan="11" class="text-center text-gray-500 py-4">没有找到符合条件的期刊。</td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    
                    <!-- 分页控件 -->
                    <div class="flex flex-wrap items-center justify-between mt-4 text-sm">
                        <div class="flex items-center space-x-2 mb-2 sm:mb-0">
                            <span class="text-gray-600">每页显示:</span>
                            <select 
                                x-model.number="itemsPerPage" 
                                @change="currentPage = 1; filterJournals()"
                                class="border rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                            >
                                <option value="10">10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span class="text-gray-600" x-text="`显示 ${filteredData[tab.id].length} 条记录中的 ${Math.min(filteredData[tab.id].length, getPaginatedData(tab.id).length)} 条`"></span>
                        </div>
                        
                        <div class="flex items-center space-x-1">
                            <button 
                                @click="currentPage = Math.max(1, currentPage - 1)" 
                                :disabled="currentPage === 1"
                                :class="{'opacity-50 cursor-not-allowed': currentPage === 1}"
                                class="px-3 py-1 border rounded hover:bg-gray-100"
                            >
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            
                            <span class="px-3 py-1 border rounded bg-gray-100">
                                <span x-text="currentPage"></span> / <span x-text="Math.ceil(filteredData[tab.id].length / itemsPerPage) || 1"></span>
                            </span>
                            
                            <button 
                                @click="currentPage = Math.min(Math.ceil(filteredData[tab.id].length / itemsPerPage) || 1, currentPage + 1)" 
                                :disabled="currentPage >= Math.ceil(filteredData[tab.id].length / itemsPerPage) || filteredData[tab.id].length === 0"
                                :class="{'opacity-50 cursor-not-allowed': currentPage >= Math.ceil(filteredData[tab.id].length / itemsPerPage) || filteredData[tab.id].length === 0}"
                                class="px-3 py-1 border rounded hover:bg-gray-100"
                            >
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <div class="mt-12 bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">数据来源</h3>
            <p class="text-gray-600 mb-4">本期刊分区表根据以下来源的数据进行整理和汇总：</p>

            <div class="space-y-2">
                <div class="flex items-start">
                    <div class="flex-shrink-0 h-5 w-5 text-blue-600">
                        <i class="fas fa-link"></i> </div>
                    <div class="ml-3">
                        <p class="text-gray-700">
                            <a href="https://www.fenqubiao.com/" class="text-blue-600 hover:underline" target="_blank">中国科学院文献情报中心期刊分区表</a> -
                            《期刊分区表》是中国科学院文献情报中心的科学研究成果，自2004年发布，延续至今
                        </p>
                    </div>
                </div>

                <div class="flex items-start">
                    <div class="flex-shrink-0 h-5 w-5 text-blue-600">
                        <i class="fas fa-link"></i> </div>
                    <div class="ml-3">
                        <p class="text-gray-700">
                            <a href="https://www.letpub.com.cn/" class="text-blue-600 hover:underline" target="_blank">LetPub学术资源</a> -
                            提供最新SCI期刊影响因子查询及投稿分析系统
                        </p>
                    </div>
                </div>

                <div class="flex items-start">
                    <div class="flex-shrink-0 h-5 w-5 text-blue-600">
                        <i class="fas fa-link"></i> </div>
                    <div class="ml-3">
                        <p class="text-gray-700">
                            <a href="https://jcr.clarivate.com/" class="text-blue-600 hover:underline" target="_blank">Journal Citation Reports (JCR)</a> -
                            由科睿唯安（Clarivate Analytics）提供的期刊引证报告
                        </p>
                    </div>
                </div>
            </div>

            <div class="mt-6 text-sm text-gray-500">
                <p>数据更新时间：2025年3月20日</p>
                <p>注意：本表仅供学术参考，具体期刊分区情况请以官方发布为准。</p>
            </div>
        </div>

        <footer class="mt-8 pt-8 border-t border-gray-200 text-center text-gray-600 text-sm">
            <p>© 2025 期刊分区查询系统 | 基于中国科学院期刊分区数据</p>
        </footer>
    </div>

    <script>
        // Alpine.js component definition
        function journalApp() {
            return {
                activeTab: '1',
                searchTerm: '',
                disciplineFilter: 'all',
                indexFilter: 'all',
                showImportModal: false,
                importFormat: 'xlsx',
                selectedFile: null,
                selectedFileName: '',
                importStatus: null,
                currentPage: 1,
                itemsPerPage: 10,
                tabs: [
                    { id: '1', name: '一区' },
                    { id: '2', name: '二区' },
                    { id: '3', name: '三区' },
                    { id: '4', name: '四区' }
                ],
                journalData: { '1': [], '2': [], '3': [], '4': [] },
                filteredData: { '1': [], '2': [], '3': [], '4': [] },
                totalFilteredJournals: 0,

                init() {
                    console.log('Initializing journal app...');
                    this.loadJournalDataFromLocalJson();
                },

                loadJournalDataFromLocalJson() {
                    fetch('./data/journals.json')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Unable to access local journal data file');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data && data.zones) {
                                // 将新的数据结构转换为应用需要的格式
                                Object.keys(data.zones).forEach(zoneId => {
                                    this.journalData[zoneId] = data.zones[zoneId].journals || [];
                                    this.filteredData[zoneId] = [...this.journalData[zoneId]];
                                });
                                
                                this.totalFilteredJournals = Object.values(this.journalData)
                                    .reduce((sum, arr) => sum + arr.length, 0);
                                    
                                this.filterJournals();
                                console.log(`Loaded journal data from JSON: ${this.totalFilteredJournals} total journals`);
                            }
                        })
                        .catch(error => {
                            console.error('Failed to load JSON data:', error);
                        });
                },

                // 简化表格初始化，不再使用DataTables库
                initializeAllDataTables() {
                    console.log('Initializing tables for all zones');
                    // 不再需要初始化DataTables，由Alpine.js直接处理表格渲染
                    // 确保所有区域的数据都已加载
                    this.tabs.forEach(tab => {
                        if (!this.filteredData[tab.id] || this.filteredData[tab.id].length === 0) {
                            this.filteredData[tab.id] = [...(this.journalData[tab.id] || [])];
                            console.log(`Loaded data for zone ${tab.id}, count: ${this.filteredData[tab.id].length}`);
                        }
                    });
                },

                // 简化的表格初始化函数
                initDataTable(zoneId) {
                    console.log(`Ensuring data is loaded for zone ${zoneId}`);
                    // 确保数据已经正确加载到filteredData中
                    if (!this.filteredData[zoneId] || this.filteredData[zoneId].length === 0) {
                        // 如果filteredData为空，从journalData重新加载
                        this.filteredData[zoneId] = [...(this.journalData[zoneId] || [])];
                        console.log(`Reloaded data for zone ${zoneId}, count: ${this.filteredData[zoneId].length}`);
                    }
                },

                // Filter journal data based on search term and dropdown selections
                filterJournals() {
                    console.log('Filtering journals...');
                    const term = this.searchTerm.toLowerCase().trim(); // Lowercase and trim search term
                    let totalCount = 0;

                    // 重置当前页码为第一页，确保筛选后从第一页开始显示
                    this.currentPage = 1;

                    this.tabs.forEach(tab => {
                        // 确保从journalData获取原始数据
                        const originalData = this.journalData[tab.id] || [];
                        console.log(`Zone ${tab.id} original data count: ${originalData.length}`);

                        // 如果原始数据为空，尝试重新初始化
                        if (originalData.length === 0) {
                            console.warn(`No data found for zone ${tab.id}, check journalData initialization`);
                        }

                        this.filteredData[tab.id] = originalData.filter(journal => {
                            // Discipline filter logic
                            const disciplineMatch = this.disciplineFilter === 'all' || journal.discipline === this.disciplineFilter;

                            // Indexing filter logic
                            const indexMatch = this.indexFilter === 'all' || (journal.indexing && journal.indexing.includes(this.indexFilter));

                            // Search term filter logic
                            const termMatch = term === '' || (
                                (journal.nameEn && journal.nameEn.toLowerCase().includes(term)) ||
                                (journal.nameCn && journal.nameCn.toLowerCase().includes(term)) ||
                                (journal.abbr && journal.abbr.toLowerCase().includes(term)) ||
                                (journal.issn && journal.issn.toLowerCase().includes(term))
                            );

                            return disciplineMatch && indexMatch && termMatch;
                        });
                        
                        console.log(`Zone ${tab.id} filtered data count: ${this.filteredData[tab.id].length}`);
                        totalCount += this.filteredData[tab.id].length; // Add count for this zone
                    });

                    this.totalFilteredJournals = totalCount; // Update total count
                    console.log(`Total filtered journals: ${this.totalFilteredJournals}`);
                    
                    // 确保当前活动标签的数据已加载
                    setTimeout(() => {
                        this.initDataTable(this.activeTab);
                    }, 50);

                    // IMPORTANT: Let Alpine handle DOM updates based on filteredData.
                    // Re-initialize DataTables *after* Alpine has updated the DOM.
                    this.$nextTick(() => {
                        // Force a small delay to ensure DOM is fully updated
                        setTimeout(() => {
                            this.tabs.forEach(tab => {
                                // Only re-initialize if the table exists for this tab
                                const tableElement = document.querySelector(`#zone-${tab.id}-table`);
                                if (tableElement) {
                                    this.initDataTable(tab.id);
                                }
                            });
                        }, 50); // Small delay to ensure DOM is ready
                    });
                },

                // 处理文件选择事件
                handleFileSelect(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    this.selectedFile = file;
                    this.selectedFileName = file.name;
                    this.importStatus = null; // 重置导入状态
                },
                
                // 导入数据处理函数
                importData() {
                    if (!this.selectedFile) {
                        this.importStatus = {
                            type: 'error',
                            message: '请先选择文件'
                        };
                        return;
                    }
                    
                    // 显示加载状态
                    this.importStatus = {
                        type: 'info',
                        message: '正在处理数据，请稍候...'
                    };
                    
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            let importedData = [];
                            
                            // 根据文件格式解析数据
                            if (this.importFormat === 'xlsx' || this.importFormat === 'xls') {
                                const data = new Uint8Array(e.target.result);
                                const workbook = XLSX.read(data, {type: 'array'});
                                const firstSheetName = workbook.SheetNames[0];
                                const worksheet = workbook.Sheets[firstSheetName];
                                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                                
                                // 处理Excel数据
                                importedData = this.processImportedData(jsonData);
                            } else if (this.importFormat === 'csv') {
                                const csvText = e.target.result;
                                // 使用XLSX库解析CSV
                                const workbook = XLSX.read(csvText, {type: 'string'});
                                const firstSheetName = workbook.SheetNames[0];
                                const worksheet = workbook.Sheets[firstSheetName];
                                const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                                
                                // 处理CSV数据
                                importedData = this.processImportedData(jsonData);
                            } else if (this.importFormat === 'json') {
                                const jsonText = e.target.result;
                                const jsonData = JSON.parse(jsonText);
                                
                                // 处理JSON数据
                                if (Array.isArray(jsonData)) {
                                    importedData = jsonData;
                                } else if (jsonData.journals && Array.isArray(jsonData.journals)) {
                                    importedData = jsonData.journals;
                                } else {
                                    throw new Error('JSON格式不正确，无法识别期刊数据');
                                }
                            }
                            
                            // 将导入的数据分配到各个分区
                            this.distributeImportedData(importedData);
                            
                            // 更新导入状态
                            this.importStatus = {
                                type: 'success',
                                message: `成功导入 ${importedData.length} 条期刊数据`
                            };
                            
                            // 重新过滤数据
                            this.filterJournals();
                            
                            // 3秒后关闭模态框
                            setTimeout(() => {
                                this.showImportModal = false;
                                this.importStatus = null;
                                this.selectedFile = null;
                                this.selectedFileName = '';
                            }, 3000);
                            
                        } catch (error) {
                            console.error('导入数据错误:', error);
                            this.importStatus = {
                                type: 'error',
                                message: `导入失败: ${error.message}`
                            };
                        }
                    };
                    
                    reader.onerror = () => {
                        this.importStatus = {
                            type: 'error',
                            message: '读取文件时发生错误'
                        };
                    };
                    
                    // 根据文件格式读取文件
                    if (this.importFormat === 'xlsx' || this.importFormat === 'xls') {
                        reader.readAsArrayBuffer(this.selectedFile);
                    } else {
                        reader.readAsText(this.selectedFile);
                    }
                },
                
                // 处理导入的数据，将其转换为标准格式
                processImportedData(data) {
                    // 如果是表格数据（有表头）
                    if (Array.isArray(data) && data.length > 1) {
                        const headers = data[0];
                        const journals = [];
                        
                        // 从第二行开始处理数据
                        for (let i = 1; i < data.length; i++) {
                            const row = data[i];
                            if (row.length === 0) continue; // 跳过空行
                            
                            // 创建期刊对象
                            const journal = {};
                            
                            // 尝试匹配列名
                            headers.forEach((header, index) => {
                                if (row[index] === undefined) return;
                                
                                const headerLower = String(header).toLowerCase();
                                
                                // 根据列名匹配字段
                                if (headerLower.includes('英文') || headerLower.includes('name') || headerLower.includes('title')) {
                                    journal.nameEn = row[index];
                                } else if (headerLower.includes('中文')) {
                                    journal.nameCn = row[index];
                                } else if (headerLower.includes('缩写') || headerLower.includes('abbr')) {
                                    journal.abbr = row[index];
                                } else if (headerLower.includes('issn')) {
                                    journal.issn = row[index];
                                } else if (headerLower.includes('影响因子') || headerLower.includes('impact')) {
                                    journal.impactFactor = row[index];
                                } else if (headerLower.includes('h') && headerLower.includes('index')) {
                                    journal.hIndex = row[index];
                                } else if (headerLower.includes('cite') || headerLower.includes('score')) {
                                    journal.citeScore = row[index];
                                } else if (headerLower.includes('jcr') || headerLower.includes('quartile') || headerLower.includes('q')) {
                                    journal.jcrQuartile = row[index];
                                } else if (headerLower.includes('大类') || headerLower.includes('category')) {
                                    journal.casCategory = row[index];
                                } else if (headerLower.includes('小类') || headerLower.includes('subcategory')) {
                                    journal.casSubcategory = row[index];
                                } else if (headerLower.includes('收录') || headerLower.includes('index')) {
                                    journal.indexing = row[index];
                                } else if (headerLower.includes('oa') || headerLower.includes('open')) {
                                    journal.isOA = row[index];
                                } else if (headerLower.includes('学科') || headerLower.includes('discipline')) {
                                    // 处理学科分类
                                    const disciplineValue = String(row[index]).toLowerCase();
                                    if (disciplineValue.includes('神经') && disciplineValue.includes('科学')) {
                                        journal.discipline = 'neuroscience';
                                    } else if (disciplineValue.includes('精神') || disciplineValue.includes('psychiatry')) {
                                        journal.discipline = 'psychiatry';
                                    } else if (disciplineValue.includes('神经') && disciplineValue.includes('病学')) {
                                        journal.discipline = 'neurology';
                                    } else if (disciplineValue.includes('心理')) {
                                        journal.discipline = 'psychology';
                                    } else if (disciplineValue.includes('药理')) {
                                        journal.discipline = 'pharmacology';
                                    } else if (disciplineValue.includes('生物化学')) {
                                        journal.discipline = 'biochemistry';
                                    } else {
                                        journal.discipline = 'other';
                                    }
                                } else if (headerLower.includes('分区') || headerLower.includes('zone')) {
                                    // 记录分区信息，用于后续分配
                                    journal.zone = row[index];
                                }
                            });
                            
                            // 确保必要字段存在
                            if (journal.nameEn) {
                                // 如果没有指定学科，根据期刊名称猜测
                                if (!journal.discipline) {
                                    const nameEn = journal.nameEn.toLowerCase();
                                    if (nameEn.includes('neuro') || nameEn.includes('brain')) {
                                        journal.discipline = 'neuroscience';
                                    } else if (nameEn.includes('psych')) {
                                        journal.discipline = 'psychiatry';
                                    } else {
                                        journal.discipline = 'other';
                                    }
                                }
                                
                                journals.push(journal);
                            }
                        }
                        
                        return journals;
                    }
                    
                    return [];
                },
                
                // 将导入的数据分配到各个分区
                distributeImportedData(importedData) {
                    if (!importedData || importedData.length === 0) return;
                    
                    importedData.forEach(journal => {
                        // 根据 LetPub 的分区信息确定期刊分区
                        let zoneId = journal.casZone || '4'; // 默认放入四区
                        
                        // 确保 journalData 中有对应的分区数组
                        if (!this.journalData[zoneId]) {
                            this.journalData[zoneId] = [];
                        }
                        
                        // 检查期刊是否已存在
                        const existingIndex = this.journalData[zoneId].findIndex(j => 
                            j.issn === journal.issn || 
                            (j.nameEn && journal.nameEn && j.nameEn.toLowerCase() === journal.nameEn.toLowerCase())
                        );
                        
                        if (existingIndex >= 0) {
                            // 更新现有期刊数据
                            this.journalData[zoneId][existingIndex] = {
                                ...this.journalData[zoneId][existingIndex],
                                ...journal
                            };
                        } else {
                            // 添加新期刊
                            this.journalData[zoneId].push(journal);
                        }
                    });
                    
                    // 更新过滤后的数据
                    this.tabs.forEach(tab => {
                        this.filteredData[tab.id] = [...this.journalData[tab.id]];
                    });
                    
                    // 更新总数
                    this.totalFilteredJournals = Object.values(this.journalData)
                        .reduce((sum, arr) => sum + arr.length, 0);
                },
                
                // 从远程JSON文件加载期刊数据
                loadJournalDataFromJson(url) {
                    fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('网络响应不正常');
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data && data.journals && Array.isArray(data.journals)) {
                                // 处理并分配数据
                                this.distributeImportedData(data.journals);
                                // 重新过滤数据
                                this.filterJournals();
                                console.log(`从JSON加载了 ${data.journals.length} 条期刊数据`);
                            }
                        })
                        .catch(error => {
                            console.error('加载JSON数据失败:', error);
                        });
                },
                
                // Export filtered data to an Excel (XLSX) file
                exportToXLSX() {
                    // Create a new workbook
                    const wb = XLSX.utils.book_new();
                    let dataToExport = [];
                     const header = ['分区', '期刊全称（英文）', '期刊全称（中文）', '期刊缩写', 'ISSN', '影响因子', 'h指数', 'CiteScore', 'JCR分区', '中科院大类', '中科院小类', '收录情况', '是否OA', '学科'];

                    // Combine data from all filtered zones
                    this.tabs.forEach(tab => {
                        this.filteredData[tab.id].forEach(journal => {
                            dataToExport.push([
                                tab.name, // Add Zone name as the first column
                                journal.nameEn || '-',
                                journal.nameCn || '-',
                                journal.abbr || '-',
                                journal.issn || '-',
                                journal.impactFactor || '-',
                                journal.hIndex || '-',
                                journal.citeScore || '-',
                                journal.jcrQuartile || '-',
                                journal.casCategory || '-',
                                journal.casSubcategory || '-',
                                journal.indexing || '-',
                                journal.isOA || '-',
                                this.getDisciplineName(journal.discipline) || '-' // Add discipline name
                            ]);
                        });
                    });

                     // Check if there is data to export
                    if (dataToExport.length === 0) {
                        alert("没有可导出的数据。请调整筛选条件。"); // Use a more user-friendly notification if possible
                        return;
                    }

                    // Add header row
                    const wsData = [header, ...dataToExport];

                    // Create a worksheet from the combined data array
                    const ws = XLSX.utils.aoa_to_sheet(wsData);

                     // Auto-adjust column widths (basic estimation)
                    const colWidths = header.map((_, i) => ({
                        wch: wsData.reduce((max, row) => Math.max(max, String(row[i] || '').length), 10) // Calculate max width, min 10
                    }));
                    ws['!cols'] = colWidths;


                    // Append the worksheet to the workbook
                    XLSX.utils.book_append_sheet(wb, ws, '期刊分区数据');

                    // Trigger the download of the XLSX file
                    XLSX.writeFile(wb, '2025年神经科学精神病学期刊分区表_筛选结果.xlsx');
                },

                // Get the count of journals in a specific zone (based on filtered data)
                getZoneJournalCount(zoneId) {
                    return this.filteredData[zoneId] ? this.filteredData[zoneId].length : 0;
                },

                // Get the display name for a discipline code
                getDisciplineName(disciplineCode) {
                    const disciplines = {
                        'neuroscience': '神经科学',
                        'psychiatry': '精神病学',
                        'neurology': '神经病学',
                        'all': '全部' // Added for display consistency
                    };
                    return disciplines[disciplineCode] || disciplineCode; // Return code if name not found
                },
                
                // 获取分页后的数据
                getPaginatedData(zoneId) {
                    if (!this.filteredData[zoneId] || this.filteredData[zoneId].length === 0) {
                        return [];
                    }
                    
                    // 确保页码不超出范围
                    const maxPage = Math.ceil(this.filteredData[zoneId].length / this.itemsPerPage) || 1;
                    if (this.currentPage > maxPage) {
                        this.currentPage = maxPage;
                    }
                    
                    const startIndex = (this.currentPage - 1) * this.itemsPerPage;
                    const endIndex = startIndex + this.itemsPerPage;
                    
                    return this.filteredData[zoneId].slice(startIndex, endIndex);
                }
            };
        }
    </script>
</body>
</html>